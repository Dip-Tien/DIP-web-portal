@using Blazored.LocalStorage;
@using Model;
@using Data;
@using MyWebERP.Base.Components.Lookup

@inherits CustEditBase

<EditForm Model="@editItem"
          OnValidSubmit="@FormSubmitted"
          id="@FormId"
          Context="EditFormContext">
    <DataAnnotationsValidator />

    <div class="row">
        <!-- Nhóm 1 -->
        <CollapseGroup Caption="@Language["Thông tin chung"]" Icon="bi-card-list" Collapsible="false" MarginBottom="3">
            <div class="card-body p-0 pt-3">
                <div class="row">
                    <div class="col-12 mb-3">
                        <i class="bi bi-upc icon-code me-1 align-middle"></i>
                        <label class="form-label fw-semibold">Mã KH</label>
                        <DxTextBox CssClass="dx-form-control"
                                   @ref="@txtCustomerCode"
                                   @bind-Text="@editItem.customer_code">
                            <Buttons>
                                <DxEditorButton IconCssClass="grid-toolbar-new"
                                                tabindex="-1"
                                                Tooltip="@Language["Tự động tạo mã mới"]"
                                                Click="@(_ => OnNewDataCodeButtonClick())" />
                            </Buttons>
                        </DxTextBox>
                        <ValidationMessage For="@(() => editItem.customer_code)" />
                    </div>

                    <div class="col-12 mb-0">
                        <i class="bi bi-person icon-person me-1 align-middle"></i>
                        <label class="form-label fw-semibold">Tên KH</label>
                        <DxTextBox CssClass="form-control"
                                   @bind-Text="@editItem.customer_name">

                        </DxTextBox>
                        <ValidationMessage For="@(() => editItem.customer_name)" />
                    </div>
                </div>
            </div>
        </CollapseGroup>

        <!-- Thông tin liên hệ -->
        <CollapseGroup Caption="@Language["Liên hệ"]" Icon="bi-telephone" MarginBottom="3" DefaultOpen="true">
            <div class="card-body p-0 pt-3">
                <div class="row">
                    <div class="col-12 mb-3">
                        <i class="bi bi-telephone icon-phone me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Điện thoại"]</label>
                        <DxTextBox InputId="tel_input" @bind-Text="@editItem.tel" CssClass="form-control" />
                    </div>

                    <div class="col-12 mb-3">
                        <i class="bi bi-envelope icon-email me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Email"]</label>
                        <DxTextBox InputId="email_input" @bind-Text="@editItem.email" CssClass="form-control" />
                    </div>

                    <div class="col-12 mb-3">
                        <i class="bi bi-geo-alt icon-province me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Tỉnh/TP"]</label>

                        <ProvinceLookupPopup @ref="provinceLookupPopup" CompanyId="@CompanyId" 
                            CompanyMenuId="@MenuItem.CompanyMenuId"
                            ActiveOnly="1"
                            TValue="string"
                            @bind-Value="@editItem.province_id"
                            SelectedItemChanged="@(async (ProvinceLookupModel p)=> await OnProvinceLookupSelected(p))" 
                            
                            CssClass="form-control">
                        </ProvinceLookupPopup>
                    </div>

                    <div class="col-12 mb-3">
                        <i class="bi bi-pin-map icon-district me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Xã/phường"]</label>
                        <DistrictLookupPopup CompanyId="@CompanyId" 
                                            CompanyMenuId="@MenuItem.CompanyMenuId" 
                                            ActiveOnly="1"
                                             TValue="string" 
                                             @ref="districtLookupPopup"
                                             @bind-Value="@editItem.district_id" 
                                             Parent="@editItem.province_id" 
                                             OnBack="OnDistrictBack"
                                             SelectedItemChanged="@(async (DistrictLookupModel p)=> await OnDistrictLookupSelected(p))"
                                             CssClass="form-control">
                        </DistrictLookupPopup>
                    </div>

                    <div class="col-12 mb-0">
                        <i class="bi bi-geo-alt icon-location me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Địa chỉ"]</label>
                        <DxMemo @bind-Text="@editItem.address1" CssClass="form-control" Id="txtAddress" />
                    </div>
                </div>
            </div>
        </CollapseGroup>

        <!-- === GROUP: THÔNG TIN KHÁC === -->
        <CollapseGroup Caption="@Language["Thông tin khác"]" Icon="bi-info-circle" DefaultOpen="true">
            <div class="card-body p-0 pt-3">
                <div class="row">
                    <!-- Phân loại -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-person icon-person me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Phân loại"]</label>
                        <DxRadioGroup TData="CustomerTypeModel" TValue="Int16" @bind-Value="editItem.is_personal"
                                      TextFieldName="@nameof(CustomerTypeModel.customer_type_name)"
                                      ValueFieldName="@nameof(CustomerTypeModel.customer_type_id)"
                                      Layout="RadioGroupLayout.Vertical"
                                      CssClass="form-control"
                                      Items="@CustomerTypeModel.GetDefaultList()">
                            <ItemTemplate Context="custType">
                                @if (custType.customer_type_id == 1)
                                {
                                    <i class="bi bi-person-check icon-person me-1"></i>
                                }
                                else
                                {
                                    <i class="bi bi-buildings icon-group me-1"></i>
                                }
                                @(Language[custType.customer_type_name])
                            </ItemTemplate>
                        </DxRadioGroup>
                    </div>

                    <!-- Giới tính -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-gender-ambiguous me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Giới tính"]</label>
                        <DxComboBox Data="@ListGender"
                                    @bind-Value="@editItem.gender_id"
                                    SearchMode="@ListSearchMode.AutoSearch"
                                    SearchFilterCondition="@ListSearchFilterCondition.Contains"
                                    NullText="@Language["Chọn giới tính"]"
                                    TextFieldName="@nameof(GenderLookupModel.gender)"
                                    ValueFieldName="@nameof(GenderLookupModel.gender_id)"
                                    CssClass="dx-form-control">
                            <ItemTemplate Context="gender">
                                @if (gender.gender == "Nam" || gender.gender == "Male")
                                {
                                    <i class="bi bi-gender-male text-primary me-1"></i>
                                }
                                else if (gender.gender == "Nữ" || gender.gender == "Female")
                                {
                                    <i class="bi bi-gender-female text-danger me-1"></i>
                                }
                                else
                                {
                                    <i class="bi bi-gender-ambiguous me-1"></i>
                                }
                                @(Language[gender.gender])
                            </ItemTemplate>
                        </DxComboBox>
                    </div>

                    <!-- Xưng hô -->
                    <div class="col-12 mb-3 border-bottom">
                        <i class="bi bi-person me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Xưng hô"]</label>
                        <DxComboBox Data="@ListVocative"
                                    @bind-Value="@editItem.vocative_id"
                                    SearchMode="@ListSearchMode.AutoSearch"
                                    SearchFilterCondition="@ListSearchFilterCondition.Contains"
                                    NullText="@Language["Chọn xưng hô"]"
                                    TextFieldName="@nameof(VocativeLookupModel.vocative)"
                                    ValueFieldName="@nameof(VocativeLookupModel.vocative_id)"
                                    CssClass="dx-form-control">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(VocativeLookupModel.vocative)" Caption="Xưng hô" Width="150" />
                            </Columns>
                        </DxComboBox>
                    </div>

                    <!-- Nhóm khách -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-people icon-group me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Nhóm khách"]</label>
                        <DxComboBox Data="@ListCategory"
                                    @bind-Value="@editItem.cust_category_id"
                                    SearchMode="@ListSearchMode.AutoSearch"
                                    SearchFilterCondition="@ListSearchFilterCondition.Contains"
                                    NullText="@Language["Chọn nhóm"]"
                                    TextFieldName="@nameof(CustCategoryLookupModel.cust_category_name)"
                                    ValueFieldName="@nameof(CustCategoryLookupModel.cust_category_id)"
                                    SelectedDataItemChanged="@((SelectedDataItemChangedEventArgs<CustCategoryLookupModel> arg) => SelectCategoryChanged(arg))"
                                    CssClass="dx-form-control">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(CustCategoryLookupModel.cust_category_name)" Caption="Tên nhóm" Width="200" />
                            </Columns>
                            <ItemTemplate Context="cate">
                                <div class="d-flex flex-column">
                                    <small class="text-muted">@cate.comment</small>
                                </div>
                            </ItemTemplate>
                            <Buttons>
                                @if (CheckLookupAddNew("CUST_CATE_LOOKUP_W"))
                                {
                                    <DxEditorButton IconCssClass="toolbar-new"
                                                    tabindex="-1"
                                                    Tooltip="@Language["Thêm nhóm khách hàng"]"
                                                    Click="@(_ => OnCustCategoryAddButtonClick())" />
                                }
                                @if (CheckLookupEdit("CUST_CATE_LOOKUP_W"))
                                {
                                    <DxEditorButton IconCssClass="toolbar-edit"
                                                    tabindex="-1"
                                                    Tooltip="@Language["Sửa nhóm khách hàng"]"
                                                    Click="@(_ => OnCustCategoryEditButtonClick())" />
                                }
                            </Buttons>
                        </DxComboBox>
                    </div>

                    <!-- Ghi chú -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-journal-text icon-note me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Ghi chú"]</label>
                        <DxMemo @bind-Text="@editItem.comment" CssClass="form-control" />
                    </div>

                    <!-- Trạng thái -->
                    <div class="col-12 mb-0">
                        <i class="bi bi-power me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Trạng thái"]</label>
                        <DxRadioGroup TData="ActiveStatusModel" TValue="Int16" @bind-Value="editItem.inactive"
                                      TextFieldName="@nameof(ActiveStatusModel.active_status_name)"
                                      ValueFieldName="@nameof(ActiveStatusModel.active_status_id)"
                                      Layout="RadioGroupLayout.Vertical"
                                      CssClass="form-control"
                                      Items="@ActiveStatusModel.GetDefaultList()">
                            <ItemTemplate Context="activeStatus">
                                @if (activeStatus.active_status_id == 1)
                                {
                                    <i class="bi bi-slash-circle text-danger me-1"></i>
                                }
                                else
                                {
                                    <i class="bi bi-check-circle text-success me-1"></i>
                                }
                                @(Language[activeStatus.active_status_name])
                            </ItemTemplate>
                        </DxRadioGroup>
                    </div>
                </div>
            </div>
        </CollapseGroup>
    </div>

</EditForm>


@if (ListLookup != null && ListLookup.FirstOrDefault(x => x.sp_code == "CUST_CATE_LOOKUP_W") != null)
{
    LookupItem lookupCustCate = ListLookup.FirstOrDefault(x => x.sp_code == "CUST_CATE_LOOKUP_W");
    MenuItem menuItemCustCate = new MenuItem(lookupCustCate);

    <CustCategoryEditPopup @bind-Visible="@CustCategoryEditPopupVisible"
    CompanyId="@CompanyId"
    EditDataId="@editItem?.cust_category_id"
                           MenuItem="@menuItemCustCate"
    LocalStorageService="@LocalStorageService"
    DataService="@DataService"
    FormStatus="@CustCategoryEditFormStatus"
    PopupClosed="@OnCustCategorySubmit" />
}

@code {
    DistrictLookupPopup<string> districtLookupPopup;
    ProvinceLookupPopup<string> provinceLookupPopup;

    protected override async Task OnProvinceLookupSelected(ProvinceLookupModel p)
    {
        await base.OnProvinceLookupSelected(p);

        if (p != null & districtLookupPopup != null)
        {
            districtLookupPopup.ShowPopup();
        }
    }

    private void OnDistrictBack()
    {
        if (provinceLookupPopup != null)
        {
            provinceLookupPopup.ShowPopup();
        }
    }
}