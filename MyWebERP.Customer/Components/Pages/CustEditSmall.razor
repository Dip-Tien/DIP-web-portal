@using Blazored.LocalStorage;
@using Model;
@using Data;
@using MyWebERP.Base.Components.Lookup
@using MyWebERP.Base.Components.Pages

@inherits CustEditBase

<EditForm Model="@editItem"
          OnValidSubmit="@FormSubmitted"
          id="@FormId"
          Context="EditFormContext">
    <DataAnnotationsValidator />

    <div class="row">
        <!-- Nhóm 1 -->
        <CollapseGroup Caption="@Language["Thông tin chung"]" Icon="bi-card-list" Collapsible="false" MarginBottom="3">
            <div class="card-body p-0 pt-3">
                <div class="row">
                    <div class="col-12 mb-3">
                        <i class="bi bi-upc icon-code me-1 align-middle"></i>
                        <label class="form-label fw-semibold">Mã KH</label>
                        <DxTextBox CssClass="dx-form-control"
                                   @ref="@txtCustomerCode"
                                   @bind-Text="@editItem.customer_code">
                            <Buttons>
                                <DxEditorButton IconCssClass="grid-toolbar-new"
                                                tabindex="-1"
                                                Tooltip="@Language["Tự động tạo mã mới"]"
                                                Click="@(_ => OnNewDataCodeButtonClick())" />
                            </Buttons>
                        </DxTextBox>
                        <ValidationMessage For="@(() => editItem.customer_code)" />
                    </div>

                    <div class="col-12 mb-0">
                        <i class="bi bi-person icon-person me-1 align-middle"></i>
                        <label class="form-label fw-semibold">Tên KH</label>
                        <DxTextBox CssClass="form-control"
                                   @bind-Text="@editItem.customer_name">

                        </DxTextBox>
                        <ValidationMessage For="@(() => editItem.customer_name)" />
                    </div>
                </div>
            </div>
        </CollapseGroup>

        <!-- Thông tin liên hệ -->
        <CollapseGroup Caption="@Language["Liên hệ"]" Icon="bi-telephone" MarginBottom="3" DefaultOpen="true">
            <div class="card-body p-0 pt-3">
                <div class="row">
                    <div class="col-12 mb-3">
                        <i class="bi bi-telephone icon-phone me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Điện thoại"]</label>
                        <DxTextBox InputId="tel_input" @bind-Text="@editItem.tel" CssClass="form-control" />
                    </div>

                    <div class="col-12 mb-3">
                        <i class="bi bi-envelope icon-email me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Email"]</label>
                        <DxTextBox InputId="email_input" @bind-Text="@editItem.email" CssClass="form-control" />
                    </div>

                    <div class="col-12 mb-3">
                        <i class="bi bi-geo-alt icon-province me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Tỉnh/TP"]</label>

                        @* <ProvinceLookupPopup @ref="provinceLookupPopup" CompanyId="@CompanyId" 
                            CompanyMenuId="@MenuItem.CompanyMenuId"
                            ActiveOnly="1"
                            TValue="string"
                            @bind-Value="@editItem.province_id"
                            SelectedItemChanged="@(async (ProvinceLookupModel p)=> await OnProvinceLookupSelected(p))" 
                            
                            CssClass="form-control">
                        </ProvinceLookupPopup> *@

                        @* <MyPopupComboBox
                            Data="ListProvince"
                            TItem="ProvinceLookupModel"
                            TValue="string"
                                         TextFieldName="@nameof(ProvinceLookupModel.province_name)"
                                         ValueFieldName="@nameof(ProvinceLookupModel.province_id)"
                            NullText="Chọn tỉnh/TP"
                            CssClass="dx-form-control"
                                         CustomFilter="@( (item, text) =>
                                                              (item.province_name?.Contains(text, StringComparison.OrdinalIgnoreCase) ?? false)
                                                              || (item.comment?.Contains(text, StringComparison.OrdinalIgnoreCase) ?? false) )"
                                         @bind-Value="@editItem.province_id">
                                         
                            <ItemTemplate Context="item">
                                <div class="flex-grow-1">
                            <div class="fw-semibold text-truncate" style="max-width: 280px;">@item.province_name</div>
                            @if (!string.IsNullOrWhiteSpace(item.comment))
                            {
                                <div class="text-muted small">@item.comment</div>
                            }
                        </div>
                            </ItemTemplate>
                            
                        </MyPopupComboBox> *@

                        <ProvincePopupComboBox TextFieldName="@nameof(ProvinceLookupModel.province_name)"
                                               ValueFieldName="@nameof(ProvinceLookupModel.province_id)"
                                               @bind-Value="@editItem.province_id"
                                               CompanyId="@CompanyId"
                                               CompanyMenuId="@MenuItem.CompanyMenuId"
                                               ActiveOnly="1"
                                               CssClass="dx-form-control"
                                               @ref="provinceLookupPopup"
                                               OnSelectedItem="@(async (ProvinceLookupModel p)=> await OnProvinceLookupSelected(p))">

                        </ProvincePopupComboBox>

                    </div>

                    <div class="col-12 mb-3">
                        <i class="bi bi-pin-map icon-district me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Xã/phường"]</label>
                        <DistrictPopupComboBox TextFieldName="@nameof(DistrictLookupModel.district_name)"
                                             ValueFieldName="@nameof(DistrictLookupModel.district_id)"
                                             @bind-Value="@editItem.district_id"
                                             Parent="@editItem.province_id"
                                             CompanyId="@CompanyId"
                                             CompanyMenuId="@MenuItem.CompanyMenuId"
                                             ActiveOnly="1"
                                               AutoLoad="true"
                                             CssClass="dx-form-control"
                                               OnBack="@(async () => await OnDistrictBack())"
                                               @ref="districtLookupPopup"
                                               OnSelectedItem="@(async (DistrictLookupModel p)=> await OnDistrictLookupSelected(p))"/>
                    </div>

                    <div class="col-12 mb-0">
                        <i class="bi bi-geo-alt icon-location me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Địa chỉ"]</label>
                        <DxMemo @bind-Text="@editItem.address1" CssClass="form-control" Id="txtAddress" />
                    </div>
                </div>
            </div>
        </CollapseGroup>

        <!-- === GROUP: THÔNG TIN KHÁC === -->
        <CollapseGroup Caption="@Language["Thông tin khác"]" Icon="bi-info-circle" DefaultOpen="true">
            <div class="card-body p-0 pt-3">
                <div class="row">
                    <!-- Phân loại -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-person icon-person me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Phân loại"]</label>
                        <DxRadioGroup TData="CustomerTypeModel" TValue="Int16" @bind-Value="editItem.is_personal"
                                      TextFieldName="@nameof(CustomerTypeModel.customer_type_name)"
                                      ValueFieldName="@nameof(CustomerTypeModel.customer_type_id)"
                                      Layout="RadioGroupLayout.Vertical"
                                      CssClass="form-control"
                                      Items="@CustomerTypeModel.GetDefaultList()">
                            <ItemTemplate Context="custType">
                                @if (custType.customer_type_id == 1)
                                {
                                    <span><i class="bi bi-person-check icon-person me-1 text-success"></i></span>
                                }
                                else
                                {
                                    <span><i class="bi bi-buildings icon-group me-1"></i></span>
                                }
                                @(Language[custType.customer_type_name])
                            </ItemTemplate>
                        </DxRadioGroup>
                    </div>

                    <!-- Giới tính -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-gender-ambiguous me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Giới tính"]</label>                                              

                        <MyComboBox Data="@ListGender"
                                    TValue="string"
                                    TItem="GenderLookupModel"
                                    NullText="@Language["Chọn giới tính"]"
                                    @bind-Value="@editItem.gender_id"
                                    ValueFieldName="@nameof(GenderLookupModel.gender_id)"
                                    TextFieldName="@nameof(GenderLookupModel.gender)"
                                    CssClass="dx-form-control">
                            <ItemTemplate Context="gender">
                                @if (gender.gender == "Nam" | gender.gender == "Male")
                                {
                                    <i class="bi bi-gender-male text-primary me-1"></i>
                                }
                                else if (gender.gender == "Nữ" | gender.gender == "Female")
                                {
                                    <i class="bi bi-gender-female text-danger me-1"></i>
                                }
                                else
                                {
                                    <i class="bi bi-gender-ambiguous me-1"></i>
                                }

                                @(Language[gender.gender])
                            </ItemTemplate>
                        </MyComboBox>
                    </div>

                    <!-- Xưng hô -->
                    <div class="col-12 mb-1">
                        <i class="bi bi-person me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Xưng hô"]</label>
                        <MyComboBox Data="@ListVocative"
                                    TValue="string"
                                    TItem="VocativeLookupModel"
                                    CssClass="dx-form-control"
                                    NullText="@Language["Chọn xưng hô"]"
                                    @bind-Value="@editItem.vocative_id"                                    
                                    ValueFieldName="@nameof(VocativeLookupModel.vocative_id)"
                                    TextFieldName="@nameof(VocativeLookupModel.vocative)">

                        </MyComboBox>
                    </div>

                    <hr class="my-2" />


                    <!-- Nhóm khách -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-people icon-group me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Nhóm khách"]</label>

                        @* <CustCategoryLookupPopup CompanyId="@CompanyId"
                                                    CompanyMenuId="@MenuItem.CompanyMenuId"
                                                    ActiveOnly="1"
                                                    TValue="string"
                                                    CssClass="dx-form-control"
                                                    @bind-Value="@editItem.cust_category_id">

                        </CustCategoryLookupPopup> *@

                        <CustCategoryPopupComboBox CompanyId="@CompanyId"
                                              CompanyMenuId="@MenuItem.CompanyMenuId"
                                              ActiveOnly="1"
                                              CssClass="dx-form-control"
                                              @bind-Value="@editItem.cust_category_id">
                            <ExtraButtons>
                                <DxEditorButton IconCssClass="bi bi-plus-lg"
                                                tabindex="-1"
                                                Visible="@(CheckLookupAddNew("CUST_CATE_LOOKUP_W") == true)"
                                                Tooltip="@Language["Thêm nhóm khách hàng"]"
                                                Click="@(_ => OnCustCategoryAddButtonClick())" />

                                <DxEditorButton IconCssClass="bi bi-pencil-square"
                                                tabindex="-1"
                                                Visible="@(CheckLookupEdit("CUST_CATE_LOOKUP_W") == true)"
                                                Tooltip="@Language["Sửa nhóm khách hàng"]"
                                                Click="@(_ => OnCustCategoryEditButtonClick())" />
                            </ExtraButtons>
                        </CustCategoryPopupComboBox>

                        @* <DxComboBox Data="@ListCategory"
                                    @bind-Value="@editItem.cust_category_id"
                                    SearchMode="@ListSearchMode.AutoSearch"
                                    SearchFilterCondition="@ListSearchFilterCondition.Contains"
                                    NullText="@Language["Chọn nhóm"]"
                                    TextFieldName="@nameof(CustCategoryLookupModel.cust_category_name)"
                                    ValueFieldName="@nameof(CustCategoryLookupModel.cust_category_id)"
                                    SelectedDataItemChanged="@((SelectedDataItemChangedEventArgs<CustCategoryLookupModel> arg) => SelectCategoryChanged(arg))"
                                    CssClass="dx-form-control">
                            <Columns>
                                <DxListEditorColumn FieldName="@nameof(CustCategoryLookupModel.cust_category_name)" Caption="Tên nhóm" Width="200" />
                            </Columns>
                            <ItemTemplate Context="cate">
                                <div class="d-flex flex-column">
                                    <small class="text-muted">@cate.comment</small>
                                </div>
                            </ItemTemplate>
                            <Buttons>
                                @if (CheckLookupAddNew("CUST_CATE_LOOKUP_W"))
                                {
                                    <DxEditorButton IconCssClass="toolbar-new"
                                                    tabindex="-1"
                                                    Tooltip="@Language["Thêm nhóm khách hàng"]"
                                                    Click="@(_ => OnCustCategoryAddButtonClick())" />
                                }
                                @if (CheckLookupEdit("CUST_CATE_LOOKUP_W"))
                                {
                                    <DxEditorButton IconCssClass="toolbar-edit"
                                                    tabindex="-1"
                                                    Tooltip="@Language["Sửa nhóm khách hàng"]"
                                                    Click="@(_ => OnCustCategoryEditButtonClick())" />
                                }
                            </Buttons>
                        </DxComboBox> *@
                    </div>

                    <!-- Ghi chú -->
                    <div class="col-12 mb-3">
                        <i class="bi bi-journal-text icon-note me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Ghi chú"]</label>
                        <DxMemo @bind-Text="@editItem.comment" CssClass="form-control" />
                    </div>

                    <!-- Trạng thái -->
                    <div class="col-12 mb-0 align-items-center">
                        <i class="bi bi-power me-1 align-middle"></i>
                        <label class="form-label fw-semibold">@Language["Trạng thái"]</label>
                        <ActiveStatusSelector @bind-Value="editItem.inactive" Horizontal="false" CssClass="form-control" />
                    </div>

                </div>
            </div>
        </CollapseGroup>
    </div>

</EditForm>


@if (ListLookup != null && ListLookup.FirstOrDefault(x => x.sp_code == "CUST_CATE_LOOKUP_W") != null)
{
    LookupItem lookupCustCate = ListLookup.FirstOrDefault(x => x.sp_code == "CUST_CATE_LOOKUP_W");
    MenuItem menuItemCustCate = new MenuItem(lookupCustCate);

    <CustCategoryEditPopup @bind-Visible="@CustCategoryEditPopupVisible"
    CompanyId="@CompanyId"
    EditDataId="@editItem?.cust_category_id"
                           MenuItem="@menuItemCustCate"
    LocalStorageService="@LocalStorageService"
    DataService="@DataService"
    FormStatus="@CustCategoryEditFormStatus"
    PopupClosed="@OnCustCategorySubmit" />
}

@code {
    // DistrictLookupPopup<string> districtLookupPopup;
    // ProvinceLookupPopup<string> provinceLookupPopup;

    ProvincePopupComboBox provinceLookupPopup;
    DistrictPopupComboBox districtLookupPopup;

    protected override async Task OnProvinceLookupSelected(ProvinceLookupModel province)
    {
        await base.OnProvinceLookupSelected(province);

        if (province != null && districtLookupPopup != null)
        {
            await districtLookupPopup.ShowPopup();
        }
    }

    private async Task OnDistrictBack()
    {
        if (provinceLookupPopup != null)
        {
            await provinceLookupPopup.ShowPopup();
        }
    }
}